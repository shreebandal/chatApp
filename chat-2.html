<!DOCTYPE html>
<html lang="en">

    <!-- Head -->

    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no,
            maximum-scale=1, shrink-to-fit=no">
        <title>Messenger - Responsive Bootstrap Application</title>

        <!-- Template core CSS -->

        <link rel="stylesheet" id="cssStyle">
        <!-- <link href="css/template.dark.css" rel="stylesheet"> -->

        <!-- Font awesome 5 -->
        <link href="fontawesome/css/all.min.css" type="text/css"
            rel="stylesheet">



    </head>
    <!-- Head -->

    <body onload="friendInfo()">

        <div class="layout">

            <div class="main main-visible" data-mobile-height="">

                <!-- Chat -->
                <div id="chat-2" class="chat dropzone-form-js"
                    data-dz-url="#">

                    <!-- Chat: body -->
                    <div class="chat-body">

                        <!-- Chat: Header -->
                        <div class="chat-header border-bottom py-4 py-lg-6
                            px-lg-8">
                            <div class="container-xxl">

                                <div class="row align-items-center">

                                    <!-- Close chat(mobile) -->
                                    <div class="col-1 d-xl-none">
                                        <ul class="list-inline mb-0">
                                            <li class="list-inline-item">
                                                <a class="text-muted px-0"
                                                    id="getback"
                                                    data-chat="open">
                                                    <i class="icon-md fa
                                                        fa-chevron-left"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>

                                    <!-- Chat photo -->
                                    <div class="col-9 col-xl-6">
                                        <div class="media text-center
                                            text-xl-left">
                                            <div id="avatar">
                                                <img class="avatar-img"
                                                    src="images/profile.jpg"
                                                    id="friendpic">
                                            </div>

                                            <div class="media-body
                                                align-self-center
                                                text-truncate">
                                                <h6 class="text-truncate mb-n1"
                                                    id="friendname"></h6>
                                                <div id="isonline">
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chat toolbar -->
                                    <div class="col-1 col-xl-6 text-right">
                                        <ul class="nav justify-content-end">
                                            <li class="nav-item list-inline-item
                                                d-none d-xl-block mr-3">
                                                <a class="nav-link text-muted
                                                    px-3" data-toggle="collapse"
                                                    data-target="#chat-2-search"
                                                    href="#" title="Search this
                                                    chat">
                                                    <i class="icon-md fa
                                                        fa-search"></i>
                                                </a>
                                            </li>

                                            <li class="nav-item list-inline-item
                                                d-none d-xl-block mr-0">
                                                <a class="nav-link text-muted
                                                    px-3" href="#"
                                                    data-chat-sidebar-toggle="#chat-2-info"
                                                    title="Details">
                                                    <i class="icon-md fa
                                                        fa-ellipsis-v"></i>
                                                </a>
                                            </li>

                                            <!-- Mobile nav -->
                                            <li class="nav-item list-inline-item
                                                d-block d-xl-none">
                                                <div class="dropdown">
                                                    <a class="nav-link
                                                        text-muted px-0"
                                                        href="#"
                                                        data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="false">
                                                        <i class="icon-md fa
                                                            fa-ellipsis-v"></i>
                                                    </a>
                                                    <div class="dropdown-menu">
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            data-toggle="collapse"
                                                            data-target="#chat-2-search"
                                                            href="#">
                                                            Search <span
                                                                class="ml-auto
                                                                pl-5 fa
                                                                fa-search"></span>
                                                        </a>

                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#"
                                                            data-chat-sidebar-toggle="#chat-2-info" 
                                                            onclick="displayFriend()">
                                                            Chat Info <span
                                                                class="ml-auto
                                                                pl-5 fa
                                                                fa-info-circle"></span>
                                                        </a>

                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#"
                                                            onclick="deleteAll()">
                                                            Delete All <span
                                                                class="ml-auto
                                                                pl-5 fa
                                                                fa-trash"></span>
                                                        </a>

                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#"
                                                            onclick="backupAll()">
                                                            Back Up <span
                                                                class="ml-auto
                                                                pl-5 fa
                                                                fa-undo"></span>
                                                        </a>
                                                    </div>
                                                </div>
                                            </li>
                                            <!-- Mobile nav -->
                                        </ul>
                                    </div>

                                </div><!-- .row -->

                            </div>
                        </div>
                        <!-- Chat: Header -->

                        <!-- Chat: Search -->
                        <div class="collapse border-bottom px-lg-8"
                            id="chat-2-search">
                            <div class="container-xxl py-4 py-lg-6">

                                <div class="input-group">
                                    <input type="text" class="form-control
                                        form-control-lg" placeholder="Search
                                        this chat" aria-label="Search this
                                        chat">

                                    <div class="input-group-append">
                                        <button class="btn btn-lg btn-ico
                                            btn-secondary btn-minimal"
                                            type="submit">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <!-- Chat: Search -->

                        <!-- Chat: Content-->
                        <div class="chat-content px-lg-8" id="Msg">
                            <div class="container-xxl py-6 py-lg-10"
                                id="addMsg">
                            </div>

                            <!-- Scroll to end -->
                            <div class="end-of-chat"></div>
                        </div>
                        <!-- Chat: Content -->

                        <!-- Chat: DropzoneJS container -->
                        <div class="chat-files hide-scrollbar px-lg-8">
                            <div class="container-xxl">
                                <div class="dropzone-previews-js form-row py-4"></div>
                            </div>
                        </div>
                        <!-- Chat: DropzoneJS container -->

                        <!-- Chat: Footer -->
                        <div class="chat-footer border-top py-4 py-lg-6
                            px-lg-8">
                            <div class="container-xxl">


                                <div class="form-row align-items-center">
                                    <div class="col">
                                        <div class="input-group">

                                            <!-- Textarea -->
                                            <textarea id="chat-id-2-input"
                                                class="form-control
                                                bg-transparent border-0"
                                                placeholder="Type your
                                                message..." rows="1"
                                                data-emoji-input=""
                                                style="overflow: hidden;" required></textarea>
                                            <!-- Emoji button -->
                                            <div class="input-group-append">
                                                <button class="btn btn-ico
                                                    btn-secondary btn-minimal
                                                    bg-transparent border-0"
                                                    type="button"
                                                    data-emoji-btn=""
                                                    onclick="sendEmoji()">
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="24" height="24"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="2"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        class="feather
                                                        feather-smile
                                                        injected-svg"><circle
                                                            cx="12" cy="12"
                                                            r="10"></circle><path
                                                            d="M8 14s1.5 2 4 2
                                                            4-2 4-2"></path><line
                                                            x1="9" y1="9"
                                                            x2="9.01" y2="9"></line><line
                                                            x1="15" y1="9"
                                                            x2="15.01" y2="9"></line></svg>
                                                </button>
                                            </div>

                                            <!-- Upload button -->
                                            <div class="input-group-append">
                                                <button
                                                    id="chat-upload-btn-2"
                                                    class="btn btn-ico
                                                    btn-secondary
                                                    btn-minimal
                                                    bg-transparent border-0
                                                    dropzone-button-js
                                                    dz-clickable"
                                                    type="button">
                                                    <svg
                                                        xmlns="http://www.w3.org/2000/svg"
                                                        width="24"
                                                        height="24"
                                                        viewBox="0 0 24 24"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        stroke-width="2"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        class="feather
                                                        feather-paperclip
                                                        injected-svg"><path
                                                            d="M21.44
                                                            11.05l-9.19
                                                            9.19a6 6 0 0
                                                            1-8.49-8.49l9.19-9.19a4
                                                            4 0 0 1 5.66
                                                            5.66l-9.2 9.19a2
                                                            2 0 0
                                                            1-2.83-2.83l8.49-8.48"></path></svg>
                                                </button>
                                            </div>

                                        </div>

                                    </div>

                                    <!-- Submit button -->
                                    <div class="col-auto">
                                        <button class="btn btn-ico
                                            btn-primary rounded-circle"
                                            type="submit" onclick="sendMsg()">
                                            <span class="fa fa-paper-plane"></span>
                                        </button>
                                    </div>

                                </div>



                            </div>
                        </div>
                        <!-- Chat: Footer -->
                    </div>
                    <!-- Chat: body -->

                    <!-- Chat Details -->
                    <div id="chat-2-info" class="chat-sidebar">
                        <div class="d-flex h-100 flex-column">

                            <!-- Header -->
                            <div class="border-bottom py-4 py-lg-6">
                                <div class="container-fluid">

                                    <ul class="nav justify-content-between
                                        align-items-center">
                                        <!-- Close sidebar -->
                                        <li class="nav-item list-inline-item">
                                            <a class="nav-link text-muted px-0"
                                                href="#"
                                                data-chat-sidebar-close="">
                                                <i class="icon-md fa
                                                    fa-chevron-left"></i>
                                            </a>
                                        </li>

                                        <!-- Title(mobile) -->
                                        <li class="text-center d-block
                                            d-lg-none">
                                            <h6 class="mb-n2" id="username"></h6>
                                            <small class="text-muted">Chat
                                                Details</small>
                                        </li>

                                        <!-- Dropdown -->
                                        <li class="nav-item list-inline-item">
                                            <div class="dropdown">
                                                <a class="nav-link text-muted
                                                    px-0" href="#"
                                                    data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="icon-md fa
                                                        fa-sliders-h"></i>
                                                </a>
                                                <div class="dropdown-menu">
                                                    <a class="dropdown-item
                                                        d-flex
                                                        align-items-center"
                                                        href="#">
                                                        Mute
                                                        <span class="ml-auto fa
                                                            fa-bell-slash"></span>
                                                    </a>
                                                    <a class="dropdown-item
                                                        d-flex
                                                        align-items-center"
                                                        href="#" onclick="unFriend()">
                                                        Unfriend
                                                        <span class="ml-auto fa
                                                            fa-trash"></span>
                                                    </a>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                </div>
                            </div>
                            <!-- Header -->

                            <!-- Body -->
                            <div class="hide-scrollbar flex-fill">

                                <div class="border-bottom text-center py-9
                                    px-10" id="info">
                                    <!-- Photo -->
                                    
                                </div>

                                <!-- Navs -->
                                <div class="nav nav-tabs nav-justified bg-light
                                    rounded-0" role="tablist" id="head">
                                    <a class="nav-item nav-link active"
                                        href="#chat-2-user-groups"
                                        data-toggle="tab" aria-selected="true"
                                        role="tab">Groups</a>
                                    <a class="nav-item nav-link"
                                        href="#chat-2-user-files"
                                        data-toggle="tab" role="tab" onclick="showImg()">Images</a>
                                </div>
                                <!-- Navs -->

                                <div class="tab-content" role="tablist">
                                    <!-- Details -->
                                    <div id="chat-2-user-groups"
                                        class="tab-pane fade show active"
                                        role="tabpanel">
                                        <ul class="list-group list-group-flush
                                            mb-8">
                                            <li class="list-group-item py-6">
                                                <div class="media
                                                    align-items-center">
                                                    <div class="media-body">
                                                        <p class="small
                                                            text-muted mb-0">Country</p>
                                                        <p>Warsaw, Poland</p>
                                                    </div>
                                                    <i class="text-muted icon-sm
                                                        fa fa-globe"></i>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                    <!-- Details -->

                                    <!-- Files -->
                                     <div id="chat-2-user-files" class="tab-pane
                                        fade" role="tabpanel">
                                        <ul class="list-group list-group-flush
                                            list-group-no-border-first" id="allImg">
                                            
                                            <!-- File -->
                                           
                                            <!-- File -->


                                        </ul>
                                    </div>
                                    <!-- Files -->
                                </div>

                            </div>
                            <!-- Body -->

                        </div>
                    </div>
                    <!-- Chat Details -->

                </div>
                <!-- Chat -->

            </div>

            <!-- DropzoneJS: Template -->
            <div id="dropzone-template-js">
                <div class="col-lg-4 my-3">
                    <div class="card bg-light">
                        <div class="card-body p-3">
                            <div class="media align-items-center">

                                <div class="dropzone-file-preview">
                                    <div class="avatar avatar rounded
                                        bg-secondary text-basic-inverse d-block
                                        mr-5">
                                        <i class="fa fa-paperclip"></i>
                                    </div>
                                </div>

                                <div class="dropzone-image-preview">
                                    <div class="avatar avatar mr-5">
                                        <img src="#" class="avatar-img rounded"
                                            data-dz-thumbnail="" alt=""
                                            id="filePic">
                                    </div>
                                </div>

                                <div class="media-body overflow-hidden">
                                    <h6 class="text-truncate small mb-0"
                                        data-dz-name id="fileName"></h6>
                                    <p class="extra-small" data-dz-size></p>
                                </div>

                                <div class="ml-5">
                                    <a href="#" class="btn btn-sm btn-link
                                        text-decoration-none text-muted"
                                        data-dz-remove>
                                        <span aria-hidden="true">&times;</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- DropzoneJS: Template -->

            <!-- Scripts -->
            <script src="js/jquery.js"></script>
            <script src="js/bootstrap.js"></script>
            <script src="js/plugin.js"></script>
            <script src="js/template.js"></script>
            <script src="js/emoji.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase.js"></script>
            <script src="js/firebase.init.js"></script>
            <!-- Scripts -->
            <script>
                let myself = ""
                if (window.location.search){
                const urlParams = new URLSearchParams(window.location.search)
                theme = urlParams.get('theme') 
                friend = urlParams.get('user')
                bff = urlParams.get('bff')
                myself = urlParams.get('myself')                 
                if(theme=="dark"){
                    document.getElementById('cssStyle').setAttribute("href", "css/template.dark.css")
                    document.getElementById('getback').setAttribute("href", "HomePage.html?theme=dark")
                }
                else {
                    document.getElementById('cssStyle').setAttribute("href", "css/template.css")
                    document.getElementById('getback').setAttribute("href", "HomePage.html?theme=light")
                }
                }
                const input = document.getElementById('chat-id-2-input')
                let count = 0
                input.addEventListener('input',()=>{
                    if(input.value.length == 23){
                    input.setAttribute("rows", "1")
                    }
                    else if(input.value.length == 47){
                    input.setAttribute("rows", "2")
                    input.setAttribute("style", "overflow: hidden")
                    }
                    else if(input.value.length == 70){
                    input.setAttribute("rows", "3")
                    input.removeAttribute("style")
                    }

                    let dataKey = ""
                    if(input.value.length > 0 && count == 0){            
                    let message = { img : "" , msg : "" , dateTime : new Date().toLocaleString() , userId : myself , isdelete : "0" , mydelete : "0" , isread : "0" , myread : "0"}
                    firebase.database().ref('chatMsg').child(friend).push(message)
                    count++
                    }
                    else if(input.value.length == 0){

                        let db = firebase.database().ref('chatMsg').child(friend)
                        db.on('value' , (users)=>{
                            users.forEach((data)=>{
                                let user = data.val()
                                if(user.img == "" && user.msg == ""){
                                    dataKey = data.key
                                }
                            })
                        })
                        firebase.database().ref('chatMsg').child(friend+'/'+dataKey).remove()
                        count--
                    }

                })

                function friendInfo(){
                    let db = firebase.database().ref('users')

                    db.on('value' , (users)=>{
                        users.forEach((data)=>{
                            let user = data.val()
                            if(bff===data.key){
                                document.getElementById('friendpic').src = user.photoURL
                                document.getElementById('friendname').innerHTML = user.name
                                if(user.lastseen === "online"){
                                document.getElementById('avatar').setAttribute("class", "avatar avatar-online avatar-sm d-lg-inline-block mr-5")
                                document.getElementById('isonline').innerHTML =
                                                    `<span class="badge badge-dot
                                                        badge-success d-inline-block
                                                        d-xl-none mr-1"></span>
                                                    <small class="text-muted">online</small>`
                                }
                                else{
                                    document.getElementById('avatar').setAttribute("class", "avatar avatar-sm d-lg-inline-block mr-5")
                                    document.getElementById('isonline').innerHTML =
                                                    `<small class="text-muted">${user.lastseen}</small>`
                                }
                            } 
                        })
                    })
                    loadChatMsg()
                    
                }

                function sendMsg(){
                    if(document.getElementById('chat-id-2-input').value != "" || document.getElementsByClassName('dropzone-previews-js')[0].innerHTML != ""){
                    let message = {}
                    if(document.getElementsByClassName('dropzone-previews-js')[0].innerHTML != ""){
                        message = { img : document.getElementById('filePic').src , msg : document.getElementById('chat-id-2-input').value , dateTime : new Date().toLocaleString() , userId : myself , isdelete : "0", mydelete : "0" , isread : "0" , myread : "0"}
                        document.getElementsByClassName('dropzone-previews-js')[0].innerHTML = ""
                    }
                    else{
                        message = { img : "" , msg : document.getElementById('chat-id-2-input').value , dateTime : new Date().toLocaleString() , userId : myself , isdelete : "0" , mydelete : "0" , isread : "0" , myread : "0" }
                    }
                    firebase.database().ref('chatMsg').child(friend).push(message,(error) => {
                        if(error){
                            alert(error)
                        }
                    })

                  
                    if(count === 1){
                    let dataKey = ""
                    let db = firebase.database().ref('chatMsg').child(friend)
                        db.on('value' , (users)=>{
                            users.forEach((data)=>{
                                let user = data.val()
                                if(user.img == "" && user.msg == ""){
                                    dataKey = data.key
                                }
                            })
                        })
                        firebase.database().ref('chatMsg').child(friend+'/'+dataKey).remove()
                        count--
                    }
                    
                    if(mytemp === 1){
                        mytemp--
                        document.getElementById('Msg').innerHTML = `<div class="container-xxl py-6 py-lg-10"
                            id="addMsg"></div>`
                            loadChatMsg()
                    }
                    
                    firebase.database().ref('fcmTokens').child(bff).once('value').then((data)=>{
                        $.ajax({
                            url : 'https://fcm.googleapis.com/fcm/send' ,
                            method : 'POST',
                            headers : {
                                'Content-Type' : 'application/json',
                                'Authorization' : 'key=AAAA6cyw39w:APA91bHoZfbP6BSo_H91JnHecsU5-uwLuA5pNdPycHl29g5CJNUyImW4Om4rKMrtqbrR2KGLaA79tbubO_Yyt-h2kyQoYLzyUj3YQkAtTkTgZr5JQNerbcps5LXeAhJH3NX9A0xtK2_N'

                            },
                            data : JSON.stringify({
                                'to' : data.val().token_id,
                                'data' : {
                                    'message' : message.msg.substring(0,30) + '...',
                                    'icon' : firebase.auth().currentUser.photoURL
                                }  
                            })
                        })
                    }) 
                    document.getElementById('chat-id-2-input').value = ""
                }
                }

                function loadChatMsg(){
                    let db = firebase.database().ref('chatMsg').child(friend)
                    db.on('value' , (users)=>{
                        let temp = ``
                        users.forEach((data)=>{
                            let mycolor = ''
                            let iscolor = ''
                            let user = data.val()
                            let dateTime = user.dateTime.split(',')
                            if(friend===bff){
                            if(user.userId === myself && user.mydelete === "0"){
                                if(user.isread === "1")
                                    mycolor = "style='color:blue'"
                                if(user.img != "" || user.msg != ""){
                                if(user.img != ""){
                                temp += `
                                    <div class="message message-right">
                            
                                    <div class="message-body">
                                    <div class="message-row">
                                            <div class="d-flex
                                                align-items-center
                                                justify-content-end">

                                                <div class="dropdown mr-3">
                                                    <a class="text-muted
                                                        opacity-60 ml-3"
                                                        href="#"
                                                        data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="false">
                                                        <i class="fa
                                                            fa-ellipsis-v"></i>
                                                    </a>

                                                    <div class="dropdown-menu">
                                                        
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="sharePic('${user.img}')">
                                                            Share <span
                                                                class="ml-auto
                                                                fa
                                                                fa-share-alt"></span>
                                                        </a>
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="deleteMsg('${data.key}')">
                                                            Delete<span
                                                                class="ml-auto
                                                                fa fa-trash"></span>
                                                        </a>
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="deleteBoth('${data.key}')">
                                                            Remove <span
                                                                class="ml-auto
                                                                fa fa-dumpster"></span>
                                                        </a>
                                                    </div>
                                                </div>

                                       
                                                <div class="message-content
                                                    bg-primary text-white">
        
                                                    <div class="form-row">
                                                        <div class="col py-3">
                                                            <img width="97%"
                                                                class="img-fluid
                                                                rounded"
                                                                src="${user.img}"
                                                                data-action="zoom"
                                                                alt="">
                                                        </div>
                                                        
                                                    </div>

                                                    <div class="mt-1">
                                                        <div>${user.msg}</div>

                                                        <div class="mt-1">
                                                            <small
                                                                class="opacity-65" style="float:right">${dateTime[1]}
                                                                <i class="fa fa-check-double" ${mycolor}></i></small>
                                                        </div>
                                                    </div>
                                                </div>
                                                                          
                                                                          
                                            </div>
                                        </div>
                                    </div>
                                        </div>

                                    `
                                    document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                              
                            }
                            else{
                                temp +=`
                                    <div class="message message-right">
                            
                                        <div class="message-body">

                                            <div class="message-row">
                                                <div class="d-flex
                                                    align-items-center
                                                    justify-content-end">

                                            
                                                    <div class="dropdown">
                                                        <a class="text-muted
                                                            opacity-60 mr-3"
                                                            href="#"
                                                            data-toggle="dropdown"
                                                            aria-haspopup="true"
                                                            aria-expanded="false">
                                                            <i class="fa
                                                                fa-ellipsis-v"></i>
                                                        </a>

                                                        <div class="dropdown-menu">
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="editMsg('${user.msg}')">
                                                                Edit <span
                                                                    class="ml-auto
                                                                    fa fa-pen"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="shareMsg('${user.msg}')">
                                                                Share <span
                                                                    class="ml-auto
                                                                    fa
                                                                    fa-share-alt"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="deleteMsg('${data.key}')">
                                                                Delete<span
                                                                    class="ml-auto
                                                                    fa fa-trash"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="deleteBoth('${data.key}')">
                                                                Remove <span
                                                                    class="ml-auto
                                                                    fa fa-dumpster"></span>
                                                            </a>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="message-content
                                                        bg-primary text-white">
                                                        <div>${user.msg}</div>

                                                        <div class="mt-1">
                                                            <small
                                                                class="opacity-65" style="float:right">${dateTime[1]}
                                                                <i class="fa fa-check-double" ${mycolor}></i></small>
                                                        </div>
                                                    </div>
                                            

                                                </div>
                                            </div>
                                        

                                        </div>
                                        
                                    </div>
                                    `
                                    document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                               
                                }
                            }
                            }
                            else if( user.mydelete === "0"){
                                if(user.img == "" && user.msg == ""){
                                temp +=  `<div class="message">
                                    
                                    <a class="avatar avatar-sm mr-4 mr-lg-5"
                                        href="#"
                                        data-chat-sidebar-toggle="#chat-2-info">
                                        <img class="avatar-img"
                                            src="${document.getElementById('friendpic').src}" alt="">
                                    </a>

                                   
                                    <div class="message-body">

                                        
                                        <div class="message-row">
                                            <div class="d-flex
                                                align-items-center">

                                                
                                                <div class="message-content
                                                    bg-light">
                                                    <div>${document.getElementById('friendname').innerHTML} is typing<span
                                                            class="typing-dots"><span>.</span><span>.</span><span>.</span></span></div>
                                                </div>
                                                

                                            </div>
                                        </div>
                                        

                                    </div>
                                    
                                </div>`
                            }else if(user.img != ""){
                                temp += `
                                <div class="message">
                                
                                <a class="avatar avatar-sm mr-4 mr-lg-5"
                                    href="#"
                                    data-chat-sidebar-toggle="#chat-2-info">
                                    <img class="avatar-img"
                                        src="${document.getElementById('friendpic').src}" alt="">
                                </a>
                            
                                    <div class="message-body">
                                    <div class="message-row">
                                            <div class="d-flex
                                                align-items-center
                                                ">

                                                                              
                                                <div class="message-content
                                                    bg-light">
        
                                                    <div class="form-row">
                                                        <div class="col py-3">
                                                            <h6 class="mb-2">${document.getElementById('friendname').innerHTML}</h6>
                                                            <img width="97%"
                                                                class="img-fluid
                                                                rounded"
                                                                src="${user.img}"
                                                                data-action="zoom"
                                                                alt="">
                                                        </div>
                                                        
                                                    </div>

                                                    <div class="mt-1">
                                                        <small
                                                            class="opacity-65" style="float:right">${dateTime[1]}
                                                            </small>
                                                    </div>
                                                </div>
                             
                                                <div class="dropdown">
                                                    <a class="text-muted
                                                        opacity-60 ml-3"
                                                        href="#"
                                                        data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="false">
                                                        <i class="fa
                                                            fa-ellipsis-v"></i>
                                                    </a>

                                                    <div class="dropdown-menu">
                                                        
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="sharePic('${user.img}')">
                                                            Share <span
                                                                class="ml-auto
                                                                fa
                                                                fa-share-alt"></span>
                                                        </a>
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="deleteMsg('${data.key}')">
                                                            Delete <span
                                                                class="ml-auto
                                                                fa fa-trash"></span>
                                                        </a>
                                                    </div>
                                     
                                                
                                                </div>
                                       
                                            </div>
                                        </div>
                                    </div>
                                        </div>

                                    `
                                    document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                                
                            }
                            else{
                                temp +=`
                                <div class="message">
                                
                                        <a class="avatar avatar-sm mr-4 mr-lg-5"
                                            href="#"
                                            data-chat-sidebar-toggle="#chat-2-info">
                                            <img class="avatar-img"
                                                src="${document.getElementById('friendpic').src}" alt="">
                                        </a>

                                        <div class="message-body">

                                            <div class="message-row">
                                                <div class="d-flex
                                                    align-items-center">

                                                    <div class="message-content
                                                        bg-light">
                                                        <h6 class="mb-2">${document.getElementById('friendname').innerHTML}</h6>
                                                        <div>${user.msg}</div>

                                                        <div class="mt-1">
                                                            <small
                                                                class="opacity-65" style="float:right">${dateTime[1]}
                                                                </small>
                                                        </div>
                                                    </div>
                            
                                                    <div class="dropdown">
                                                        <a class="text-muted
                                                            opacity-60 ml-3"
                                                            href="#"
                                                            data-toggle="dropdown"
                                                            aria-haspopup="true"
                                                            aria-expanded="false">
                                                            <i class="fa
                                                                fa-ellipsis-v"></i>
                                                        </a>

                                                        <div class="dropdown-menu">
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="editMsg('${user.msg}')">
                                                                Edit <span
                                                                    class="ml-auto
                                                                    fa fa-pen"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="shareMsg('${user.msg}')">
                                                                Share <span
                                                                    class="ml-auto
                                                                    fa
                                                                    fa-share-alt"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="deleteMsg('${data.key}')">
                                                                Delete <span
                                                                    class="ml-auto
                                                                    fa fa-trash"></span>
                                                            </a>
                                                        </div>
                                                    </div>
            
                                                </div>
                                            </div>
                            
                                        </div>
                        
                                    </div>
                                    `
                                    document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                                
                                }
                            }
                        }
                        else {
                            if(user.userId !== myself && user.isdelete === "0"){
                                if(user.img == "" && user.msg == ""){
                                temp +=  `<div class="message">
                                    
                                    <a class="avatar avatar-sm mr-4 mr-lg-5"
                                        href="#"
                                        data-chat-sidebar-toggle="#chat-2-info">
                                        <img class="avatar-img"
                                            src="${document.getElementById('friendpic').src}" alt="">
                                    </a>

                                   
                                    <div class="message-body">

                                        
                                        <div class="message-row">
                                            <div class="d-flex
                                                align-items-center">

                                                
                                                <div class="message-content
                                                    bg-light">
                                                    <div>${document.getElementById('friendname').innerHTML} is typing<span
                                                            class="typing-dots"><span>.</span><span>.</span><span>.</span></span></div>
                                                </div>
                                                

                                            </div>
                                        </div>
                                        

                                    </div>
                                    
                                </div>`
                            }
                            else if(user.img != ""){
                                    temp += `
                                <div class="message">
                                
                                <a class="avatar avatar-sm mr-4 mr-lg-5"
                                    href="#"
                                    data-chat-sidebar-toggle="#chat-2-info">
                                    <img class="avatar-img"
                                        src="${document.getElementById('friendpic').src}" alt="">
                                </a>
                            
                                    <div class="message-body">
                                    <div class="message-row">
                                            <div class="d-flex
                                                align-items-center
                                                ">

                                                                              
                                                <div class="message-content
                                                    bg-light">
        
                                                    <div class="form-row">
                                                        <div class="col py-3">
                                                            <h6 class="mb-2">${document.getElementById('friendname').innerHTML}</h6>
                                                            <img width="97%"
                                                                class="img-fluid
                                                                rounded"
                                                                src="${user.img}"
                                                                data-action="zoom"
                                                                alt="">
                                                        </div>
                                                        
                                                    </div>

                                                    <div class="mt-1">
                                                        <small
                                                            class="opacity-65" style="float:right">${dateTime[1]}
                                                            </small>
                                                    </div>
                                                </div>
                             
                                                <div class="dropdown">
                                                    <a class="text-muted
                                                        opacity-60 ml-3"
                                                        href="#"
                                                        data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="false">
                                                        <i class="fa
                                                            fa-ellipsis-v"></i>
                                                    </a>

                                                    <div class="dropdown-menu">
                                                        
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="sharePic('${user.img}')">
                                                            Share <span
                                                                class="ml-auto
                                                                fa
                                                                fa-share-alt"></span>
                                                        </a>
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="deleteMsg('${data.key}')">
                                                            Delete <span
                                                                class="ml-auto
                                                                fa fa-trash"></span>
                                                        </a>
                                                    </div>
                                     
                                                
                                                </div>
                                       
                                            </div>
                                        </div>
                                    </div>
                                        </div>

                                    `
                                    document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                                 
                            }
                            else{
                                temp +=`
                                <div class="message">
                                
                                <a class="avatar avatar-sm mr-4 mr-lg-5"
                                    href="#"
                                    data-chat-sidebar-toggle="#chat-2-info">
                                    <img class="avatar-img"
                                        src="${document.getElementById('friendpic').src}" alt="">
                                </a>

                                <div class="message-body">

                                    <div class="message-row">
                                        <div class="d-flex
                                            align-items-center">

                                            <div class="message-content
                                                bg-light">
                                                <h6 class="mb-2">${document.getElementById('friendname').innerHTML}</h6>
                                                <div>${user.msg}</div>

                                                <div class="mt-1">
                                                    <small
                                                        class="opacity-65" style="float:right">${dateTime[1]}
                                                        </small>
                                                </div>
                                            </div>
                    
                                            <div class="dropdown">
                                                <a class="text-muted
                                                    opacity-60 ml-3"
                                                    href="#"
                                                    data-toggle="dropdown"
                                                    aria-haspopup="true"
                                                    aria-expanded="false">
                                                    <i class="fa
                                                        fa-ellipsis-v"></i>
                                                </a>

                                                <div class="dropdown-menu">
                                                    <a class="dropdown-item
                                                        d-flex
                                                        align-items-center"
                                                        href="#" onclick="editMsg('${user.msg}')">
                                                        Edit <span
                                                            class="ml-auto
                                                            fa fa-pen"></span>
                                                    </a>
                                                    <a class="dropdown-item
                                                        d-flex
                                                        align-items-center"
                                                        href="#" onclick="shareMsg('${user.msg}')">
                                                        Share <span
                                                            class="ml-auto
                                                            fa
                                                            fa-share-alt"></span>
                                                    </a>
                                                    <a class="dropdown-item
                                                        d-flex
                                                        align-items-center"
                                                        href="#" onclick="deleteMsg('${data.key}')">
                                                        Delete <span
                                                            class="ml-auto
                                                            fa fa-trash"></span>
                                                    </a>
                                                </div>
                                            </div>
    
                                        </div>
                                    </div>
                    
                                </div>
                
                            </div>
                            `
                            document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                     
                        }
                        }
                        else if( user.isdelete === "0"){
                            if(user.myread === "1")
                                iscolor = "style='color:blue'"
                            if(user.img != "" || user.msg != ""){
                            if(user.img != ""){
                                temp += `
                                    <div class="message message-right">
                            
                                    <div class="message-body">
                                    <div class="message-row">
                                            <div class="d-flex
                                                align-items-center
                                                justify-content-end">

                                                <div class="dropdown mr-3">
                                                    <a class="text-muted
                                                        opacity-60 ml-3"
                                                        href="#"
                                                        data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="false">
                                                        <i class="fa
                                                            fa-ellipsis-v"></i>
                                                    </a>

                                                    <div class="dropdown-menu">
                                                        
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="sharePic('${user.img}')">
                                                            Share <span
                                                                class="ml-auto
                                                                fa
                                                                fa-share-alt"></span>
                                                        </a>
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="deleteMsg('${data.key}')">
                                                            Delete<span
                                                                class="ml-auto
                                                                fa fa-trash"></span>
                                                        </a>
                                                        <a class="dropdown-item
                                                            d-flex
                                                            align-items-center"
                                                            href="#" onclick="deleteBoth('${data.key}')">
                                                            Remove <span
                                                                class="ml-auto
                                                                fa fa-dumpster"></span>
                                                        </a>
                                                    </div>
                                                </div>

                                       
                                                <div class="message-content
                                                    bg-primary text-white">
        
                                                    <div class="form-row">
                                                        <div class="col py-3">
                                                            <img width="97%"
                                                                class="img-fluid
                                                                rounded"
                                                                src="${user.img}"
                                                                data-action="zoom"
                                                                alt="">
                                                        </div>
                                                        
                                                    </div>

                                                    <div class="mt-1">
                                                        <small
                                                            class="opacity-65" style="float:right">${dateTime[1]}
                                                            <i class="fa fa-check-double" ${iscolor}></i></small>
                                                    </div>
                                                </div>
                                                                          
                                                                          
                                            </div>
                                        </div>
                                    </div>
                                        </div>

                                    `
                                    document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                                    
                                    
                            }
                            else{
                        temp +=`
                                    <div class="message message-right">
                            
                                        <div class="message-body">

                                            <div class="message-row">
                                                <div class="d-flex
                                                    align-items-center
                                                    justify-content-end">

                                            
                                                    <div class="dropdown">
                                                        <a class="text-muted
                                                            opacity-60 mr-3"
                                                            href="#"
                                                            data-toggle="dropdown"
                                                            aria-haspopup="true"
                                                            aria-expanded="false">
                                                            <i class="fa
                                                                fa-ellipsis-v"></i>
                                                        </a>

                                                        <div class="dropdown-menu">
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="editMsg('${user.msg}')">
                                                                Edit <span
                                                                    class="ml-auto
                                                                    fa fa-pen"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="shareMsg('${user.msg}')">
                                                                Share <span
                                                                    class="ml-auto
                                                                    fa
                                                                    fa-share-alt"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="deleteMsg('${data.key}')">
                                                                Delete<span
                                                                    class="ml-auto
                                                                    fa fa-trash"></span>
                                                            </a>
                                                            <a class="dropdown-item
                                                                d-flex
                                                                align-items-center"
                                                                href="#" onclick="deleteBoth('${data.key}')">
                                                                Remove <span
                                                                    class="ml-auto
                                                                    fa fa-dumpster"></span>
                                                            </a>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="message-content
                                                        bg-primary text-white">
                                                        <div>${user.msg}</div>

                                                        <div class="mt-1">
                                                            <small
                                                                class="opacity-65" style="float:right">${dateTime[1]}
                                                                <i class="fa fa-check-double" ${iscolor}></i></small>
                                                        </div>
                                                    </div>
                                            

                                                </div>
                                            </div>
                                        

                                        </div>
                                        
                                    </div>
                                    `
                                    document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                                    
                                    
                                }
                            }
                        }
                        }
                        })
                        document.getElementById('addMsg').innerHTML = temp
                        document.getElementById('Msg').scrollTo(0,document.getElementById('Msg').scrollHeight)
                    })
                }

                function editMsg(msg){
                    document.getElementById('chat-id-2-input').value = msg
                }

                function shareMsg(msg){
                    let myfriend = ""
                    document.getElementById('chat-2').innerHTML = ``
                    let db = firebase.database().ref('friends')
                    db.on('value' , (users)=>{
                            users.forEach((data)=>{
                                let user = data.val()
                                if(user.me === myself){                   
                                    let db1 = firebase.database().ref('users')
                                    let temp = user.you
                                    db1.on('value' , (users)=>{
                                        users.forEach((data)=>{
                                            let user = data.val()
                                            if(user.email === temp){
                                                myfriend = data.key
                                                
                                                document.getElementById('chat-2').innerHTML +=`
                                                <a class="text-reset" style="margin:30px"
                                                onclick="sendMsgTo('${msg}','${myfriend}')" >
                                                    <div class="card
                                                        card-active-listener">
                                                        <div class="card-body">

                                                            <div class="media">

                                                                <div class="avatar
                                                                    avatar-online mr-5">
                                                                    <img
                                                                        class="avatar-img"
                                                                        src="${user.photoURL}"
                                                                        >
                                                                </div>


                                                                <div class="media-body
                                                                    overflow-hidden">
                                                                    <div class="d-flex
                                                                        align-items-center
                                                                        mb-1">
                                                                        <h6
                                                                            class="text-truncate
                                                                            mb-0
                                                                            mr-auto">${user.name}</h6>
                                                                        <p class="small
                                                                            text-muted
                                                                            text-nowrap
                                                                            ml-4">10:42
                                                                            am</p>
                                                                    </div>
                                                                    <div
                                                                        class="text-truncate">${user.email}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </div>


                                                    </div>
                                                </a>
                                                `
                                            }
                                        })
                                    })
                                }
                                else if(user.you === myself){                  
                                    let db1 = firebase.database().ref('users')
                                    let temp = user.me
                                  
                                    db1.on('value' , (users)=>{
                                        users.forEach((data)=>{
                                            let user = data.val()
                                            if(user.email === temp){ 

                                            let database = firebase.database().ref('users')
                                            database.on('value' , (users)=>{
                                                users.forEach((data)=>{
                                                    let user = data.val()
                                                    if(user.email === myself)
                                                        myfriend = data.key
                                                })
                                            })

                                            document.getElementById('chat-2').innerHTML +=`
                                                <a class="text-reset" style="margin:30px"
                                                    onclick="sendMsgTo('${msg}','${myfriend}')" >
                                                    <div class="card
                                                        card-active-listener">
                                                        <div class="card-body">

                                                            <div class="media">

                                                                <div class="avatar
                                                                    avatar-online mr-5">
                                                                    <img
                                                                        class="avatar-img"
                                                                        src="${user.photoURL}"
                                                                        >
                                                                </div>


                                                                <div class="media-body
                                                                    overflow-hidden">
                                                                    <div class="d-flex
                                                                        align-items-center
                                                                        mb-1">
                                                                        <h6
                                                                            class="text-truncate
                                                                            mb-0
                                                                            mr-auto">${user.name}</h6>
                                                                        <p class="small
                                                                            text-muted
                                                                            text-nowrap
                                                                            ml-4">10:42
                                                                            am</p>
                                                                    </div>
                                                                    <div
                                                                        class="text-truncate">${user.email}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </div>


                                                    </div>
                                                </a>
                                                `
                                            }
                                        })
                                    })
                                }
                        })
                    })
                }

                function sendMsgTo(mymsg,myfriend){
                    let message = { img : "" , msg : mymsg , dateTime : new Date().toLocaleString() , userId : myself , isdelete : "0" , mydelete : "0" , isread : "0" , myread : "0" }

                    firebase.database().ref('chatMsg').child(myfriend).push(message,(error) => {
                        if(error){
                            alert(error)
                        }
                    })

                    location.replace("chat-2.html?theme="+theme+"&user="+friend+"&myself="+myself+"&bff="+bff)
                }

                function sharePic(pic){
                    let myfriend = ""
                    document.getElementById('chat-2').innerHTML = ``
                    let db = firebase.database().ref('friends')
                    db.on('value' , (users)=>{
                            users.forEach((data)=>{
                                let user = data.val()
                                if(user.me === myself){                   
                                    let db1 = firebase.database().ref('users')
                                    let temp = user.you
                                    db1.on('value' , (users)=>{
                                        users.forEach((data)=>{
                                            let user = data.val()
                                            if(user.email === temp){
                                                myfriend = data.key
                                                
                                                document.getElementById('chat-2').innerHTML +=`
                                                <a class="text-reset" style="margin:30px"
                                                onclick="sendPicTo('${pic}','${myfriend}')" >
                                                    <div class="card
                                                        card-active-listener">
                                                        <div class="card-body">

                                                            <div class="media">

                                                                <div class="avatar
                                                                    avatar-online mr-5">
                                                                    <img
                                                                        class="avatar-img"
                                                                        src="${user.photoURL}"
                                                                        >
                                                                </div>


                                                                <div class="media-body
                                                                    overflow-hidden">
                                                                    <div class="d-flex
                                                                        align-items-center
                                                                        mb-1">
                                                                        <h6
                                                                            class="text-truncate
                                                                            mb-0
                                                                            mr-auto">${user.name}</h6>
                                                                        <p class="small
                                                                            text-muted
                                                                            text-nowrap
                                                                            ml-4">10:42
                                                                            am</p>
                                                                    </div>
                                                                    <div
                                                                        class="text-truncate">${user.email}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </div>


                                                    </div>
                                                </a>
                                                `
                                            }
                                        })
                                    })
                                }
                                else if(user.you === myself){                  
                                    let db1 = firebase.database().ref('users')
                                    let temp = user.me
                                  
                                    db1.on('value' , (users)=>{
                                        users.forEach((data)=>{
                                            let user = data.val()
                                            if(user.email === temp){ 

                                            let database = firebase.database().ref('users')
                                            database.on('value' , (users)=>{
                                                users.forEach((data)=>{
                                                    let user = data.val()
                                                    if(user.email === myself)
                                                        myfriend = data.key
                                                })
                                            })

                                            document.getElementById('chat-2').innerHTML +=`
                                                <a class="text-reset" style="margin:30px"
                                                    onclick="sendPicTo('${pic}','${myfriend}')" >
                                                    <div class="card
                                                        card-active-listener">
                                                        <div class="card-body">

                                                            <div class="media">

                                                                <div class="avatar
                                                                    avatar-online mr-5">
                                                                    <img
                                                                        class="avatar-img"
                                                                        src="${user.photoURL}"
                                                                        >
                                                                </div>


                                                                <div class="media-body
                                                                    overflow-hidden">
                                                                    <div class="d-flex
                                                                        align-items-center
                                                                        mb-1">
                                                                        <h6
                                                                            class="text-truncate
                                                                            mb-0
                                                                            mr-auto">${user.name}</h6>
                                                                        <p class="small
                                                                            text-muted
                                                                            text-nowrap
                                                                            ml-4">10:42
                                                                            am</p>
                                                                    </div>
                                                                    <div
                                                                        class="text-truncate">${user.email}
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </div>


                                                    </div>
                                                </a>
                                                `
                                            }
                                        })
                                    })
                                }
                        })
                    })                    
                }

                function sendPicTo(mypic,myfriend){
                    let message = { img : mypic , msg : "" , dateTime : new Date().toLocaleString() , userId : myself , isdelete : "0" , mydelete : "0" , isread : "0" , myread : "0" }

                    firebase.database().ref('chatMsg').child(myfriend).push(message,(error) => {
                        if(error){
                            alert(error)
                        }
                    })

                    location.replace("chat-2.html?theme="+theme+"&user="+friend+"&myself="+myself+"&bff="+bff)
                }  
                
                function deleteMsg(datakey){
                    let db = firebase.database().ref('chatMsg').child(friend)
                    let message = {}
                        db.on('value' , (users)=>{
                            users.forEach((data)=>{
                                let user = data.val()
                                if(data.key === datakey){
                                    if(friend === bff)
                                        message = { img : user.img , msg : user.msg , dateTime : user.dateTime , userId : user.userId , isdelete : user.isdelete , mydelete : "1" , isread : user.isread , myread : user.myread }
                                    else
                                        message = { img : user.img , msg : user.msg , dateTime : user.dateTime , userId : user.userId , isdelete : "1" , mydelete : user.mydelete , isread : user.isread , myread : user.myread }

                                    
                                }
                            })
                        })
                        firebase.database().ref('chatMsg').child(friend+'/'+datakey).update(message)
                }

                function deleteBoth(datakey){
                    firebase.database().ref('chatMsg').child(friend+'/'+datakey).remove()
                }

                function deleteAll(){
                    let db = firebase.database().ref('chatMsg').child(friend)
                    let message = {}
                        db.on('value' , (users)=>{
                            users.forEach((data)=>{
                                let user = data.val()
                                    if(friend === bff)
                                        message = { img : user.img , msg : user.msg , dateTime : user.dateTime , userId : user.userId , isdelete : user.isdelete , mydelete : "1" , isread : user.isread , myread : user.myread }
                                    else
                                        message = { img : user.img , msg : user.msg , dateTime : user.dateTime , userId : user.userId , isdelete : "1" , mydelete : user.mydelete , isread : user.isread , myread : user.myread }
                                        
                                    firebase.database().ref('chatMsg').child(friend+'/'+data.key).update(message) 
                            })
                        }) 
                        setTimeout(() => { location.replace("chat-2.html?theme="+theme+"&user="+friend+"&myself="+myself+"&bff="+bff)  }, 1000)  
                               
                        
                }

                function backupAll(){
                    let db = firebase.database().ref('chatMsg').child(friend)
                    let message = {}
                        db.on('value' , (users)=>{
                            users.forEach((data)=>{
                                let user = data.val()
                                    if(friend === bff)
                                        message = { img : user.img , msg : user.msg , dateTime : user.dateTime , userId : user.userId , isdelete : user.isdelete , mydelete : "0" , isread : user.isread , myread : user.myread }
                                    else
                                        message = { img : user.img , msg : user.msg , dateTime : user.dateTime , userId : user.userId , isdelete : "0" , mydelete : user.mydelete , isread : user.isread , myread : user.myread }
                                        
                                    firebase.database().ref('chatMsg').child(friend+'/'+data.key).update(message)
                            })
                        })  
                        setTimeout(() => { location.replace("chat-2.html?theme="+theme+"&user="+friend+"&myself="+myself+"&bff="+bff)  }, 1000)                      
                }

                function displayFriend(){
                    let db = firebase.database().ref('users')

                    let pic = ""
                    let name = ""
                    let bio = ""

                    db.on('value' , (users)=>{
                        users.forEach((data)=>{
                            let user = data.val()
                            if(bff===data.key){
                                pic = user.photoURL
                                name = user.name
                                bio = user.bio
                            } 
                        })
                    })

                    document.getElementById('username').innerHTML = name

                    document.getElementById('info').innerHTML =
                    `<div class="avatar avatar-xl mx-5 mb-5">
                        <img class="avatar-img"
                            src="${pic}" alt="">
                    </div>
                    <h5>${name}</h5>
                    <p class="text-muted">${bio}</p>`
                }

                function showImg(){
                    let db = firebase.database().ref('chatMsg').child(friend)
                    let temp = ``

                    db.on('value' , (users)=>{
                        users.forEach((data)=>{
                            let user = data.val()
                            if(friend===bff && user.mydelete === "0" ){
                            if(user.img !== ""){
                                temp +=     `<li class="list-group-item py-6">
                                                <div class="media">

                                                    <div class="avatar avatar-sm
                                                        d-lg-inline-block mr-5">
                                                        <img class="avatar-img"
                                                            src="${user.img}" alt="">
                                                    </div>

                                                    <div class="media-body
                                                        align-self-center
                                                        overflow-hidden">
                                                        <h6 class="text-truncate
                                                            mb-0">
                                                            <a href="#"
                                                                class="text-reset"
                                                                title="${user.msg}">${user.msg}</a>
                                                        </h6>

                                                        <ul class="list-inline
                                                            small mb-0">
                                                            <li
                                                                class="list-inline-item">
                                                                <span
                                                                    class="text-muted">${user.dateTime}</span>
                                                            </li>
                                                        </ul>
                                                    </div>

                                                    <div
                                                        class="align-self-center
                                                        ml-5">
                                                        <div class="dropdown">
                                                            <a href="#"
                                                                class="btn
                                                                btn-sm btn-ico
                                                                btn-link
                                                                text-muted
                                                                w-auto"
                                                                data-toggle="dropdown"
                                                                aria-haspopup="true"
                                                                aria-expanded="false">
                                                                <i class="fa
                                                                    fa-ellipsis-v"></i>
                                                            </a>
                                                            <div
                                                                class="dropdown-menu">
                                                                <a
                                                                    class="dropdown-item
                                                                    d-flex
                                                                    align-items-center"
                                                                    href="#" onclick="sharePic('${user.img}')">
                                                                    Share <span
                                                                        class="ml-auto
                                                                        fa
                                                                        fa-share-alt"></span>
                                                                </a>
                                                                <a
                                                                    class="dropdown-item
                                                                    d-flex
                                                                    align-items-center"
                                                                    href="#" onclick="deleteMsg('${data.key}')">
                                                                    Delete <span
                                                                        class="ml-auto
                                                                        fa
                                                                        fa-trash"></span>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </li>`
                            }
                        }
                        else if(friend!==bff && user.isdelete === "0"){
                            if(user.img !== ""){
                                temp +=     `<li class="list-group-item py-6">
                                                <div class="media">

                                                    <div class="avatar avatar-sm
                                                        d-lg-inline-block mr-5">
                                                        <img class="avatar-img"
                                                            src="${user.img}" alt="">
                                                    </div>

                                                    <div class="media-body
                                                        align-self-center
                                                        overflow-hidden">
                                                        <h6 class="text-truncate
                                                            mb-0">
                                                            <a href="#"
                                                                class="text-reset"
                                                                title="${user.msg}">${user.msg}</a>
                                                        </h6>

                                                        <ul class="list-inline
                                                            small mb-0">
                                                            <li
                                                                class="list-inline-item">
                                                                <span
                                                                    class="text-muted">${user.dateTime}</span>
                                                            </li>
                                                        </ul>
                                                    </div>

                                                    <div
                                                        class="align-self-center
                                                        ml-5">
                                                        <div class="dropdown">
                                                            <a href="#"
                                                                class="btn
                                                                btn-sm btn-ico
                                                                btn-link
                                                                text-muted
                                                                w-auto"
                                                                data-toggle="dropdown"
                                                                aria-haspopup="true"
                                                                aria-expanded="false">
                                                                <i class="fa
                                                                    fa-ellipsis-v"></i>
                                                            </a>
                                                            <div
                                                                class="dropdown-menu">
                                                                <a
                                                                    class="dropdown-item
                                                                    d-flex
                                                                    align-items-center"
                                                                    href="#" onclick="sharePic('${user.img}')">
                                                                    Share <span
                                                                        class="ml-auto
                                                                        fa
                                                                        fa-share-alt"></span>
                                                                </a>
                                                                <a
                                                                    class="dropdown-item
                                                                    d-flex
                                                                    align-items-center"
                                                                    href="#" onclick="deleteMsg('${data.key}')">
                                                                    Delete <span
                                                                        class="ml-auto
                                                                        fa
                                                                        fa-trash"></span>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </li>`
                            }
                        }
                        })
                    })
                    document.getElementById('allImg').innerHTML = temp 

                }

                function unFriend(){
                    let db = firebase.database().ref('users')

                    let email = ""

                    db.on('value' , (users)=>{
                        users.forEach((data)=>{
                            let user = data.val()
                            if(bff == data.key){
                                email = user.email
                            } 
                        })
                    })

                    let db1 = firebase.database().ref('friends')

                    db1.on('value' , (users)=>{
                        users.forEach((data)=>{
                            let user = data.val()
                            if((user.me === email && user.you === myself) || (user.you === email && user.me === myself)){
                                db1.child(data.key).remove()
                                location.replace("HomePage.html?theme="+theme)
                            } 
                        })
                    })
                }
                    
            </script>
        </body>

    </html>
